services:
    ten-percent:
        image: node:20-alpine
        container_name: sl-web-server-front-end
        working_dir: /app

        command:
            ['sh', '-c', 'corepack enable && corepack prepare pnpm@latest --activate && pnpm install --force && pnpm run dev']

        environment:
            # Redis
            - REDIS_MASTER_NAME=mymaster
            - SENTINEL_NODES=redis-sentinel-1:26379,redis-sentinel-2:26379,redis-sentinel-3:26379
            - REDIS_PASSWORD=redispassword
            - REDIS_SENTINEL_PASSWORD=sentinelpassword
            - REDIS_DB=0

            # PostgreSQL
            - PGHOST=postgres
            - PGPORT=5432
            - PGDATABASE=test_db
            - PGUSER=test_user
            - PGPASSWORD=test_password
        ports:
            - '3000:3000'
        volumes:
            - ./logs:/logs
            - ./../../:/app
        networks:
            - app-tier
    redis-master:
        container_name: redis-master
        image: 'bitnami/redis:latest'
        environment:
            - REDIS_REPLICATION_MODE=master
            - REDIS_PASSWORD=redispassword
        ports:
            - '6379:6379'
        networks:
            - app-tier
    postgres:
        container_name: postgres
        image: postgres:16-alpine
        volumes:
            - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
        environment:
            - POSTGRES_DB=test_db
            - POSTGRES_USER=test_user
            - POSTGRES_PASSWORD=test_password
        ports:
            - '5432:5432'
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U test_user -d test_db']
            interval: 5s
            timeout: 5s
            retries: 5
        networks:
            - app-tier
networks:
    app-tier:
        driver: bridge
